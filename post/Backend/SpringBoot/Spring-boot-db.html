<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Spring Boot：（三）ORM - Creaink - Build something for life</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Creaink" /><meta name="description" content="Spring Boot 入门之 Spring MVC" /><meta name="keywords" content="Spring, Spring Boot, JavaWeb, Spring Boot 2, ORM, JPA, Mybatis" />






<meta name="generator" content="Hugo 0.53 with even 4.0.0" />


<link rel="canonical" href="https://creaink.github.io/post/Backend/SpringBoot/Spring-boot-db.html" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.56003f67.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Spring Boot：（三）ORM" />
<meta property="og:description" content="Spring Boot 入门之 Spring MVC" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://creaink.github.io/post/Backend/SpringBoot/Spring-boot-db.html" /><meta property="article:published_time" content="2019-02-06T14:10:00&#43;08:00"/>
<meta property="article:modified_time" content="2019-02-06T14:10:00&#43;08:00"/>

<meta itemprop="name" content="Spring Boot：（三）ORM">
<meta itemprop="description" content="Spring Boot 入门之 Spring MVC">


<meta itemprop="datePublished" content="2019-02-06T14:10:00&#43;08:00" />
<meta itemprop="dateModified" content="2019-02-06T14:10:00&#43;08:00" />
<meta itemprop="wordCount" content="3965">



<meta itemprop="keywords" content="Spring Boot,JavaWeb,Mybatis,ORM,JPA," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Spring Boot：（三）ORM"/>
<meta name="twitter:description" content="Spring Boot 入门之 Spring MVC"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Creaink</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post.html">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags.html">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories.html">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/links.html">
        <li class="mobile-menu-item">Links</li>
      </a><a href="/about.html">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Creaink</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post.html">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags.html">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories.html">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/links.html">Links</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about.html">About</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Spring Boot：（三）ORM</h1>

      <div class="post-meta">
        <span class="post-time">&nbsp;<i class="iconfont icon-calendar"></i> 2019-02-06 </span>
          <span class="more-meta"> <i class="iconfont icon-book"></i> 3965 words </span>
          <span class="more-meta"> <i class="iconfont icon-clock"></i> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#准备">准备</a>
<ul>
<li><a href="#datasource">datasource</a></li>
</ul></li>
<li><a href="#jdbctemplate">JdbcTemplate</a>
<ul>
<li><a href="#典型-jdbc">典型 jdbc</a></li>
<li><a href="#利用-jdbctemplate-实现映射">利用 jdbcTemplate 实现映射</a></li>
</ul></li>
<li><a href="#jpa">JPA</a>
<ul>
<li><a href="#jpa-映射实体类">JPA 映射实体类</a></li>
<li><a href="#jpa-接口定义">JPA 接口定义</a></li>
<li><a href="#jpa-的配置">JPA 的配置</a></li>
</ul></li>
<li><a href="#mybatis">Mybatis</a>
<ul>
<li><a href="#mapper">Mapper</a></li>
<li><a href="#获取创建的数据">获取创建的数据</a></li>
</ul></li>
<li><a href="#mybatis-plus">MyBatis-Plus</a></li>
<li><a href="#h2-database">h2 database</a></li>
<li><a href="#事务">事务</a>
<ul>
<li><a href="#传播行为">传播行为</a></li>
</ul></li>
<li><a href="#连接池">连接池</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<h2 id="准备">准备</h2>

<p>先解决 Jackson 和 数据库的时区问题，在配置文件当中加入：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-properties" data-lang="properties"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-properties" data-lang="properties">spring.jackson.time-zone=GMT+8
spring.datasource.url=jdbc:mysql://localhost:3306/dbname?serverTimezone=GMT%2B8</code></pre></td></tr></table>
</div>
</div>
<h3 id="datasource">datasource</h3>

<p>DataSource 是 Spring 简化数据库配置的方式，首先加入数据库的依赖</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-jdbc<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></td></tr></table>
</div>
</div>
<p>配置数据库连接，这里的是我习惯的配置方式（host, port, dbname 是自定义的），这里的配置不需要指定 <code>spring.datasource.driver-class-name=com.mysql.jdbc.Driver</code>，因为 spring boot 会自动配置。这里的配置仅仅是最小配置，诸如数据库连接细节、连接池等可以更加需求自行配置。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-properties" data-lang="properties"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-properties" data-lang="properties">spring.datasource.host=127.0.0.1
spring.datasource.port=3306
spring.datasource.dbname=spring
spring.datasource.username=root
spring.datasource.password=wsad

spring.datasource.url=jdbc:mysql://${spring.datasource.host}:${spring.datasource.port}/${spring.datasource.dbname}</code></pre></td></tr></table>
</div>
</div>
<h2 id="jdbctemplate">JdbcTemplate</h2>

<h3 id="典型-jdbc">典型 jdbc</h3>

<p>典型的 jdbc 连接数据库通常可以这样做：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;com.mysql.cj.jdbc.Driver&#34;</span><span class="o">);</span>
<span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="s">&#34;jdbc:mysql://127.0.0.1/spring&#34;</span><span class="o">,</span> <span class="s">&#34;root&#34;</span><span class="o">,</span> <span class="s">&#34;wsad&#34;</span><span class="o">);</span>

<span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;select id, name, address from user where id = ?&#34;</span><span class="o">;</span>
<span class="n">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
<span class="n">ps</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
<span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="na">getResultSet</span><span class="o">();</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="o">+</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">)</span> <span class="o">+</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;address&#34;</span><span class="o">));</span></code></pre></td></tr></table>
</div>
</div>
<p>其中获取连接的部分可以由注入 Datasource 和 DataSource.getConnection() 完成。但是这种传统方式的从结果集到 POJO 的转换都是些很重复的步骤利用 jdbcTemplate 的 RowMapper 可以简化。</p>

<h3 id="利用-jdbctemplate-实现映射">利用 jdbcTemplate 实现映射</h3>

<p>编写 UserService 的 CURDL 接口</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// service.JdbcTmplUserService.java
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">JdbcTmplUserService</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">findUsers</span><span class="o">(</span><span class="n">String</span> <span class="n">uname</span><span class="o">,</span> <span class="n">String</span> <span class="n">address</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">insertUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">updateUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>编写 UserService 的实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// service.impl.JdbcTmplUserServiceImpl.java
</span><span class="c1"></span><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JdbcTmplUserServiceImpl</span> <span class="kd">implements</span> <span class="n">JdbcTmplUserService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">JdbcTemplate</span> <span class="n">jdbcTemplate</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">RowMapper</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUserMapper</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 对于小于 java 8 的可能需要使用声明类或者匿名类
</span><span class="c1"></span>        <span class="n">RowMapper</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">userRowMapper</span> <span class="o">=</span> <span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">rownum</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
            <span class="n">user</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">));</span>
            <span class="n">user</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">));</span>
            <span class="n">user</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;address&#34;</span><span class="o">));</span>
            <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
        <span class="o">};</span>
        <span class="k">return</span> <span class="n">userRowMapper</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;select id, name, address from user where id = ?&#34;</span><span class="o">;</span>
        <span class="n">Object</span><span class="o">[]</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span><span class="n">id</span><span class="o">};</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">queryForObject</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">params</span><span class="o">,</span> <span class="n">getUserMapper</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">findUsers</span><span class="o">(</span><span class="n">String</span> <span class="n">uname</span><span class="o">,</span> <span class="n">String</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;select id, name, address from user &#34;</span>
                    <span class="o">+</span> <span class="s">&#34;where name like concat (&#39;%&#39;, ?, &#39;%&#39;) &#34;</span>
                    <span class="o">+</span> <span class="s">&#34;and address like concat (&#39;%&#39;, ?, &#39;%&#39;) &#34;</span><span class="o">;</span>

        <span class="n">Object</span><span class="o">[]</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span><span class="n">uname</span><span class="o">,</span> <span class="n">address</span><span class="o">};</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span><span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">params</span><span class="o">,</span> <span class="n">getUserMapper</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">users</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">insertUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;insert into user (name, address) values (?, ?)&#34;</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">user</span><span class="o">.</span><span class="na">getAddress</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">updateUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;update user set name = ?, address = ? &#34;</span>
                    <span class="o">+</span> <span class="s">&#34;where id = ?&#34;</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">user</span><span class="o">.</span><span class="na">getAddress</span><span class="o">(),</span> <span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;delete from user where id = ? &#34;</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>上面的需要说明的几点</p>

<ul>
<li>利用 <code>@Autowired</code> 注入 JdbcTemplate 类型 bean （由 spring 在配置里获取 datasource）以供后面使用，Template 里屏蔽了数据库连接的打开关闭等等操作。</li>
<li>在 JdbcTemplate 里的映射关系是需要自己实现 RowMapper 接口，也就是抽取从结果集到 POJO 的逻辑，统一应用。</li>
</ul>

<p>随后相应的 Controller 里简单的处理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/user&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>
   <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/{id}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userService</span><span class="o">.</span><span class="na">getUser</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="n">consumes</span> <span class="o">=</span> <span class="s">&#34;application/json&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">createUser</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userService</span><span class="o">.</span><span class="na">insertUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="jpa">JPA</h2>

<p>JPA(Java Persistence API)是定义了 ORM 以及实体对象持久化的标准接口。JPA 是 JSR-220 的一部分，在 Spring boot 中的 JPA 是依靠 Hibernate 来实现的。</p>

<p>JPA 所维护的核心是实体(Entity Bean)，而他是通过一个持久化上下文来使用的，该上下文包含以下 3 部分：</p>

<ul>
<li><p>对象关系映射(Object Relational Mapping，简称ORM，或O/RM，或O/R映射）描述，JPA 支持注解或 XML 两种形式的描述，在 SpringBoot 中主要通过注解实现；</p></li>

<li><p>实体操作 API, 通过这节规范可以实现对实体对象的 CRUD 操作，来完成对象的持久化和查询；</p></li>

<li><p>查询语言，约定了面向对象的查询语言 JPQL(JavaPersistenceQueryLanguage)，通过这层关系可以实现比较灵活的查询。</p></li>
</ul>

<p>下面对 JPA 的简单使用作介绍。</p>

<h3 id="jpa-映射实体类">JPA 映射实体类</h3>

<p>先添加 JPA 的依赖。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-jpa<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></td></tr></table>
</div>
</div>
<p>需要定义实体类，并将该类与数据库中的表做对应。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// entity.User.java
</span><span class="c1">// Entity 标明为实体类，Table 定义映射的表
</span><span class="c1"></span><span class="nd">@Entity</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#34;user&#34;</span><span class="o">)</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#34;user&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>

    <span class="c1">// 定义属性和表字段关系，默认为字段名
</span><span class="c1"></span>    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;name&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">address</span><span class="o">;</span>

    <span class="c1">// getter and setter
</span><span class="c1"></span><span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="jpa-接口定义">JPA 接口定义</h3>

<p>使用 JPA 的话，默认附带一些简单的方法，也有两种方式实现复杂场景下的查询：JPA 查询语言 和 JPA 命名查询，这两种方式都可以在定义接口时候完成的，其接口的具体实现由 JPA 来动态完成。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// dao.JpaUserRepository.java
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">JpaUserRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="c1">// JAP 查询语言（JPQL）
</span><span class="c1"></span>    <span class="nd">@Query</span><span class="o">(</span><span class="s">&#34;select u.address from user u where u.id = ?1 &#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getUserAddress</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">);</span>

    <span class="c1">// 命名查询
</span><span class="c1"></span>    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsersByAddressIn</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">address</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>getUserAddress 使用注解和 JPQL 语言来完成查询；而命名查询使用接口方法的名字来组成响应的语义，如这里的 getUsersByAddressIn 的方法名其实是有实际含义的，以 get/find 动词开头，以 by 定义用什么字段查询，in 表示使用的是范围等等。在 IDEA 中编写时候会有相应的提示，这里仅仅是对这两种方式简单的解释下。</p>

<ul class="task-list">
<li><label><input type="checkbox" disabled class="task-list-item"> JPA 深入学习</label></li>
</ul>

<h3 id="jpa-的配置">JPA 的配置</h3>

<p>如需注册 JPA 的实体类和接口，不能以简单的 Spring 方式加入上下文中（无具体的含义），需要在 Spring boot 的启动类中加上两个 <code>@EnableJpaRepositories</code> <code>@EntityScan</code> 注解实现扫描。数据库的配置，使用先前的 <code>spring.datasource</code> 即可。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableJpaRepositories</span><span class="o">(</span><span class="n">basePackages</span> <span class="o">=</span> <span class="s">&#34;contacts.dao&#34;</span><span class="o">)</span>
<span class="nd">@EntityScan</span><span class="o">(</span><span class="n">basePackages</span> <span class="o">=</span> <span class="s">&#34;contacts.entity&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ContactsApplication</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">ContactsApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>之后就可以在编写相应的 web 服务，将由 JPA 生成的实现了自定义的 JpaUserRepository 接口的实现注入到 jpaUserRepository 中。JPA 的 update 和 create 可以由 save 方法来实现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/jpa&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JpaController</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">JpaUserRepository</span> <span class="n">jpaUserRepository</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">&#34;/user&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">createUser</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">jpaUserRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/user/byAddress&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUserInAddress</span><span class="o">(</span><span class="nd">@RequestParam</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">jpaUserRepository</span><span class="o">.</span><span class="na">getUsersByAddressIn</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/address/{id}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getUserAddress</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">jpaUserRepository</span><span class="o">.</span><span class="na">getUserAddress</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/user/{id}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">jpaUserRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">id</span><span class="o">).</span><span class="na">get</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="mybatis">Mybatis</h2>

<p>Mybatis 相比 JPA 和 Hibernate 更为简单、灵活。避免了几乎所有的 JDBC 代码和手动设置参数以及获取结果集，采用 SQL 语句来制定功能，无需定义类似 JPA 的 Entity，POJO(Plain Old Java Objects) 即可。</p>

<p>添加 mybatis 的依赖，注意这里要指明下版本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.mybatis.spring.boot<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>mybatis-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.3.2<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="mapper">Mapper</h3>

<p>和 JPA 一样，只需要定义接口即可，类似 JPQL 的方式注解来指明动作，只不过是使用的 SQL 语句，如这里的采用的 MySQL：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// mapper.UserMapper.java
</span><span class="c1"></span><span class="nd">@Repository</span>
<span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserMapper</span> <span class="o">{</span>

    <span class="nd">@Select</span><span class="o">(</span><span class="s">&#34;select id, name, address from user where id = #{id}&#34;</span><span class="o">)</span>
    <span class="n">User</span> <span class="nf">getUserById</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="kt">int</span> <span class="n">id</span><span class="o">);</span>

    <span class="nd">@Insert</span><span class="o">(</span><span class="s">&#34;insert into user (name, address) &#34;</span> <span class="o">+</span>
            <span class="s">&#34;values(#{u.name}, #{u.address})&#34;</span><span class="o">)</span>
    <span class="kt">void</span> <span class="nf">createUser</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&#34;u&#34;</span><span class="o">)</span> <span class="n">User</span> <span class="n">user</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>上面的几点说明：</p>

<ul>
<li>接口使用 <code>@Mapper</code> 注解，就无需配置了。这里的 <code>@Repository</code> 不是必须的，加了之后可以避免注入时候 IDEA 里报找不到 bean 的错误。</li>
<li><code>@Select</code> 和 <code>@Insert</code> 里的为改接口的 SQL 语句，<code>#{}</code> 的形式指定对应接口参数指定的名称（使用 <code>@Param</code> 注解的），可以使用 <code>.</code> 访问对象参数里的成员（通过 get 方法）</li>
<li>结果集由 mybatis 自动获取、填充到接口方法的返回值当中。</li>
</ul>

<p>编写简单的 REST 控制器（这里省略掉 service 接口和 service 实现，正确的方式是应当在 service 里 注入 UserMapper）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/mybatis&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MybaitsController</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserMapper</span> <span class="n">userMapper</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/user/{id}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userMapper</span><span class="o">.</span><span class="na">getUserById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/user&#34;</span><span class="o">,</span> <span class="n">consumes</span> <span class="o">=</span> <span class="s">&#34;application/json&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createUser</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">userMapper</span><span class="o">.</span><span class="na">createUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">&#34;Success&#34;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>返回的结果默认是以名称绑定的，如果字段名和 POJO 的不一致需要使用 <code>@Results</code> 和 <code>@Result</code> 指定下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Results</span><span class="o">({</span>
        <span class="nd">@Result</span><span class="o">(</span><span class="n">property</span> <span class="o">=</span> <span class="s">&#34;name&#34;</span><span class="o">,</span> <span class="n">column</span> <span class="o">=</span> <span class="s">&#34;name&#34;</span><span class="o">),</span>
        <span class="nd">@Result</span><span class="o">(</span><span class="n">property</span> <span class="o">=</span> <span class="s">&#34;address&#34;</span><span class="o">,</span> <span class="n">column</span> <span class="o">=</span> <span class="s">&#34;address&#34;</span><span class="o">),</span>
<span class="o">})</span>
<span class="nd">@Select</span><span class="o">(</span><span class="s">&#34;select id, name, address from user where id = #{id}&#34;</span><span class="o">)</span>
<span class="n">User</span> <span class="nf">getUserById</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="kt">int</span> <span class="n">id</span><span class="o">);</span></code></pre></td></tr></table>
</div>
</div>
<p>一般的在数据库中，由于不同平台大小写敏感程度不一样，一般字段和表名都是以下划线分隔的，在 java 中一般是以驼峰风格命名的，如 <code>gmt_create</code> 到 <code>gmtCreate</code> 这样的转换可以直接由配置来完成，如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-properties" data-lang="properties"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-properties" data-lang="properties">mybatis.configuration.map-underscore-to-camel-case=true</code></pre></td></tr></table>
</div>
</div>
<p>更多功能和特性参考 <a href="http://www.mybatis.org/mybatis-3/zh/java-api.html" target="_blank">mybatis 文档</a>。不过，由于 Java 注解的一些限制加之某些 MyBatis 映射的复杂性，XML 映射对于大多数高级映射（比如：嵌套 Join 映射）来说仍然是必须的。</p>

<h3 id="获取创建的数据">获取创建的数据</h3>

<p>在 REST 接口中常常需要在 create 之后返回资源对象本身或者 id，但是在上面的 createUser Mapper 当中，返回值除了 void 之外还可以是 int （SQL 返回），如果创建成功的话，POJO 对象里的数据肯定是照样存入数据库当中，但是有些自动生成的字段，在创建成功之后存在于数据库中，但是没有反映到传入的 POJO 中。这时候直接返回 POJO 会缺少哪些字段更新/创建字段的信息，比如比较致命的 ID。</p>

<p>还好在 mybatis 中可以使用 <code>@SelectKey</code> 或者 <code>@Options</code> 这两个注解完成这个需求:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Repository</span>
<span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserMapper</span> <span class="o">{</span>
    <span class="c1">// before=false 即 after，在运行完 SQL 之后再执行 select @@IDENTITY 并 set 到传入的 POJO u.id 之中
</span><span class="c1"></span>    <span class="nd">@SelectKey</span><span class="o">(</span><span class="n">statement</span> <span class="o">=</span> <span class="s">&#34;select @@IDENTITY&#34;</span><span class="o">,</span> <span class="n">keyProperty</span> <span class="o">=</span> <span class="s">&#34;u.id&#34;</span><span class="o">,</span> <span class="n">before</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">resultType</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kt">int</span> <span class="nf">createUser1</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&#34;u&#34;</span><span class="o">)</span> <span class="n">User</span> <span class="n">user</span><span class="o">);</span>

    <span class="nd">@Options</span><span class="o">(</span><span class="n">useGeneratedKeys</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">keyProperty</span> <span class="o">=</span> <span class="s">&#34;u.id&#34;</span><span class="o">,</span> <span class="n">keyColumn</span> <span class="o">=</span> <span class="s">&#34;id&#34;</span><span class="o">)</span>
    <span class="kt">int</span> <span class="nf">createUser2</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&#34;u&#34;</span><span class="o">)</span> <span class="n">User</span> <span class="n">user</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>可以通过配置 <code>mybatis.configuration.log-impl=org.apache.ibatis.logging.stdout.StdOutImpl</code> 来输出原生 SQL，上面的两个方式打印出 SQL 看球来是这样的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-txt" data-lang="txt"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-txt" data-lang="txt">==&gt;  Preparing: insert into user (name, address) values( ?, ?)
==&gt; Parameters: Scott(String), Jingzhou(String)
&lt;==    Updates: 1
==&gt;  Preparing: select @@IDENTITY
==&gt; Parameters:
&lt;==    Columns: @@IDENTITY
&lt;==        Row: 20
&lt;==      Total: 1

==&gt;  Preparing: insert into user (name, address) values( ?, ?)
==&gt; Parameters: Scott(String), Jingzhou(String)
&lt;==    Updates: 1</code></pre></td></tr></table>
</div>
</div>
<p>很明显 <code>@SelectKey</code> 会再执行一条 SQL 语句，而使用 <code>useGeneratedKeys</code> 的方式貌似只会使用一条语句，但是是怎么获取到插入的 ID 的还有待探究（直接看 MySQL 的 general_log 在前期也是看不到获取 @@IDENTITY 的这样操作的）。所以平时可能使用 <code>useGeneratedKeys</code> 可能效率更好些。</p>

<h2 id="mybatis-plus">MyBatis-Plus</h2>

<ul class="task-list">
<li><label><input type="checkbox" disabled class="task-list-item"> MyBatis-Plus

<ul>
<li><a href="https://mp.baomidou.com/guide/" target="_blank">https://mp.baomidou.com/guide/</a></li>
</ul></label></li>
</ul>

<p>MyBatis-Plus（简称 MP）是一个 MyBatis 的增强工具，国人的一个开源程序，在 MyBatis 的基础上只做增强不做改变，为简化开发、提高效率而生。</p>

<h2 id="h2-database">h2 database</h2>

<ul class="task-list">
<li><label><input type="checkbox" disabled class="task-list-item"> 使用 h2 内存数据库用于单元测试，fixture。</label></li>
</ul>

<h2 id="事务">事务</h2>

<p>Spring AOP 的约定使得事务处理更加简化，不必编写大量的重复的事务的处理如：setAutoCommit, setTransactionIsolation, roolback, try catch 等等，利用 <code>@Transactional</code> 即可将业务切面独立出来，将其它的枯燥的代码隐藏于 Spring 切面之中。</p>

<p><code>@Transactional</code> 可以注解接口，也可以注解实现类。通常情况下推荐在实现类里面注解，方便使用 CGLIB 动态代理，不然就只能使用 JDK 的动态代理（？）。</p>

<p>Spring 中事务管理器的顶层接口为 PlatformTransactionManager，使用 mybatis-spring-boot-starter 之后会自动创建一个 DataSourceTransactionManager 作为事务管理器。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MybatisUserServiceImpl</span> <span class="kd">implements</span> <span class="n">UserService</span> <span class="o">{</span>
    <span class="c1">// Transactional 一般放在 service 层，而不是 dao 层
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">isolation</span> <span class="o">=</span> <span class="n">Isolation</span><span class="o">.</span><span class="na">READ_COMMITTED</span><span class="o">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">1</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">insertUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">userMapper</span><span class="o">.</span><span class="na">createUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="c1">// ...
</span><span class="c1"></span><span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>可以在名为 <code>spring.datasource.*</code> 的配置项中设置各个连接的默认事务级别，数据库隔离级别参考 <a href="/Backend/Database/Transaction.md">Transaction</a>。</p>

<p>造成成回滚的 exception 可以过滤定义，如 <code>@Transactional( rollbackFor={Exception.class, ...})</code>，或者过滤掉某些 <code>@Transactional(notRollbackFor=RunTimeException.class)</code>，一般来说需要时 Runtime Exception 的子类。</p>

<h3 id="传播行为">传播行为</h3>

<p>在大规模的业务代码中，有可能分为几个小的独立步骤，这时候如果将事务边界设置为整段代码，那么独立的步骤即使成功也将回滚。例如批量操作插入，为了更好的处理这种情况就需要涉及到事务的传播。</p>

<p>可以在 <code>@Transactional</code> 注解中使用 <code>propagation</code> 参数指定事务传播方式，总的来说有一下的几种方式（有注释的为较为重要的）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">enum</span> <span class="n">Propagation</span> <span class="o">{</span>
    <span class="n">REQUIRED</span><span class="o">(</span><span class="n">0</span><span class="o">),</span>        <span class="c1">// 默认，需要事务，如果当前存在事务就沿用当前事务，否则新建
</span><span class="c1"></span>    <span class="n">SUPPORTS</span><span class="o">(</span><span class="n">1</span><span class="o">),</span>
    <span class="n">MANDATORY</span><span class="o">(</span><span class="n">2</span><span class="o">),</span>
    <span class="n">REQUIRES_NEW</span><span class="o">(</span><span class="n">3</span><span class="o">),</span>    <span class="c1">// 无论事务存在与否，都会创建新事务（非嵌套子事务），即则把当前事务挂起。
</span><span class="c1"></span>    <span class="n">NOT_SUPPORTED</span><span class="o">(</span><span class="n">4</span><span class="o">),</span>
    <span class="n">NEVER</span><span class="o">(</span><span class="n">5</span><span class="o">),</span>
    <span class="n">NESTED</span><span class="o">(</span><span class="n">6</span><span class="o">);</span>          <span class="c1">// 嵌套事务，只会回滚当前方法调用出错的子事务的 SQL
</span><span class="c1"></span>    <span class="c1">// ...
</span><span class="c1"></span><span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>然后可以使用 <code>@Transactional(isolation = Isolation.READ_COMMITTED, timeout = 1, propagation = Propagation.REQUIRED)</code>。</p>

<p>需要注意的是，对于一个 service 内的事务方法的组合相互调用，propagation 是无效的，因为 AOP 是通过动态代理完成的，<strong>类里的方法间的调用是没有经过代理的处理的</strong>。要想完成既定的需求可以从 context 中获取本 class 的实例然后在调用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MybatisUserServiceImpl</span> <span class="kd">implements</span> <span class="n">UserService</span><span class="o">,</span> <span class="n">ApplicationContextAware</span><span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserMapper</span> <span class="n">userMapper</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setApplicationContext</span><span class="o">(</span><span class="n">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">BeansException</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">applicationContext</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">updateUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ...
</span><span class="c1"></span>    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">isolation</span> <span class="o">=</span> <span class="n">Isolation</span><span class="o">.</span><span class="na">READ_COMMITTED</span><span class="o">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">1</span><span class="o">,</span> <span class="n">propagation</span> <span class="o">=</span> <span class="n">Propagation</span><span class="o">.</span><span class="na">REQUIRED</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">insertUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">UserService</span> <span class="n">userService</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">UserService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">// ...
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>更多的关于事务传播的知识可以参考 <a href="https://www.cnblogs.com/duanxz/p/4746892.html" target="_blank">事务之六：spring 嵌套事务</a></p>

<h2 id="连接池">连接池</h2>

<ul class="task-list">
<li><label><input type="checkbox" disabled class="task-list-item"> HikariProxyConnection?</label></li>
<li><label><input type="checkbox" disabled class="task-list-item"> druid</label></li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content"><a href="https://creaink.github.com" class="theme-link">Creaink</a></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">2019-02-06</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div><footer class="post-footer">
      <div class="post-tags">
        <div style="margin-bottom:5px">
          <i class="iconfont icon-folder-open"></i>
            <a href="/categories/Spring/">Spring</a>
            </div>
        <div>
          <i class="iconfont icon-label"></i>
            <a href="/tags/Spring-Boot/">Spring Boot</a>
            <a href="/tags/JavaWeb/">JavaWeb</a>
            <a href="/tags/Mybatis/">Mybatis</a>
            <a href="/tags/ORM/">ORM</a>
            <a href="/tags/JPA/">JPA</a>
            </div>
      </div>

      
      <nav class="post-nav">
        
        <a class="next" href="/post/Backend/SpringBoot/Spring-boot-mvc.html">
            <span class="next-text nav-default">Spring Boot：（二）MVC</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="lv-container" data-id="city" data-uid="MTAyMC80MjAzOS8xODU4Ng">
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];

        if (typeof LivereTower === 'function') { return; }

        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;

        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
    <noscript>Please enable JavaScript to view the comments powered by <a href="https://livere.com/">LiveRe.</a></noscript>
    </div>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:gcreaink@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/creaink" class="iconfont icon-github" title="github"></a>
  <a href="https://creaink.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author"><a href="https://creaink.github.com" class="theme-link">Creaink</a></span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-131846852-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
