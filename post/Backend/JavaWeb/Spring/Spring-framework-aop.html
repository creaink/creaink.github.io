<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Spring framework 之面向切面编程 - Creaink - Build something for life</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Creaink" /><meta name="description" content="Spring framework 之面向切面编程" /><meta name="keywords" content="Spring, Spring framework, JavaWeb, AOP, 面向切面编程" />






<meta name="generator" content="Hugo 0.53 with even 4.0.0" />


<link rel="canonical" href="https://creaink.github.io/post/Backend/JavaWeb/Spring/Spring-framework-aop.html" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.56003f67.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Spring framework 之面向切面编程" />
<meta property="og:description" content="Spring framework 之面向切面编程" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://creaink.github.io/post/Backend/JavaWeb/Spring/Spring-framework-aop.html" /><meta property="article:published_time" content="2019-01-23T14:05:00&#43;08:00"/>
<meta property="article:modified_time" content="2019-01-23T14:05:00&#43;08:00"/>

<meta itemprop="name" content="Spring framework 之面向切面编程">
<meta itemprop="description" content="Spring framework 之面向切面编程">


<meta itemprop="datePublished" content="2019-01-23T14:05:00&#43;08:00" />
<meta itemprop="dateModified" content="2019-01-23T14:05:00&#43;08:00" />
<meta itemprop="wordCount" content="2296">



<meta itemprop="keywords" content="Spring,JavaWeb," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Spring framework 之面向切面编程"/>
<meta name="twitter:description" content="Spring framework 之面向切面编程"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Creaink</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post.html">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags.html">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories.html">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/links.html">
        <li class="mobile-menu-item">Links</li>
      </a><a href="/about.html">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Creaink</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post.html">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags.html">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories.html">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/links.html">Links</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about.html">About</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Spring framework 之面向切面编程</h1>

      <div class="post-meta">
        <span class="post-time">&nbsp;<i class="iconfont icon-calendar"></i> 2019-01-23 </span>
          <span class="more-meta"> <i class="iconfont icon-book"></i> 2296 words </span>
          <span class="more-meta"> <i class="iconfont icon-clock"></i> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#基本概念">基本概念</a></li>
<li><a href="#注解式">注解式</a>
<ul>
<li><a href="#切入点语法">切入点语法</a></li>
<li><a href="#pointcut">pointcut</a></li>
<li><a href="#advice">advice</a></li>
<li><a href="#advice-参数">advice 参数</a></li>
<li><a href="#declareparents">DeclareParents</a></li>
</ul></li>
<li><a href="#配置式">配置式</a></li>
<li><a href="#参考">参考</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>AOP(Aspect-Oriented-Programming) 面向切面编程，其原理是使用动态代理去间接的调用接口，以方便代理者在代理调用过程前后加入私货（重复代码）的处理，以简化代码。也达到了在线性逻辑当中，以非入侵方式的切开线性逻辑加入自己的逻辑面（切面），是对面向对象的思维方式的一种有力的补充。</p>

<h2 id="基本概念">基本概念</h2>

<p>Spring 基于 AspectJ 的动态代理的原理实现了 AOP，在正式开始之前先了解下面的几个概念：</p>

<ul>
<li>joinpoint, 连接点, 程序执行的某个特定位置

<ul>
<li>Before</li>
<li>After</li>
<li>After-returning</li>
<li>After-throwing</li>
<li>Around</li>
</ul></li>
<li>pointcut, 切点, 如果连接点相当于数据中的记录，那么切点相当于查询条件，一个切点可以匹配多个连接点。</li>
<li>advice, 增强,某个切面在特定连接点(joinpoint)处采取的操作即程序代码。</li>
<li>aspect, 切面, 切面是由切点和增强（引介）组成的，它包括了对横切关注功能的定义，也包括了对连接点的定义。</li>
</ul>

<h2 id="注解式">注解式</h2>

<p>预备的代码基本与 <a href="https://creaink.github.io/post/Backend/JavaWeb/Spring/Spring-framework-di.html" target="_blank">依赖注入篇</a> 时候相同，这里以如何实现为 <code>src/main/java/demo/service/UserService.java</code> 的 add 方法加上日志切面作为目的，进行讲解。为此新建一个 LogIntercepter.java 文件内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// demo/aop/LogIntercepter.java
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogIntercepter</span>  <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">after</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;after user add&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">before</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;before user add&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>先加上 AspectJ 的依赖：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.aspectj<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>aspectjweaver<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>RELEASE<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></td></tr></table>
</div>
</div>
<p>为使用的配置类加上 <code>@EnableAspectJAutoProxy</code> 注解：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Configuration</span>
<span class="nd">@ComponentScan</span><span class="o">(</span><span class="n">basePackages</span> <span class="o">=</span> <span class="s">&#34;demo&#34;</span><span class="o">)</span>
<span class="nd">@EnableAspectJAutoProxy</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDaoConfig</span> <span class="o">{</span>
    <span class="c1">//...
</span><span class="c1"></span><span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>为 LogIntercepter 类加上 <code>@Component</code> 注解以加入 spring 上下文，之后再加上 <code>@Aspect</code> 注解声明切面类，使用切入点语法为 after 和 before 方法分部加上 After 和 Before 的 advcie，最后以使得 spring 根据此类和其切入点语法创建自动代理。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Component</span>
<span class="nd">@Aspect</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogIntercepter</span>  <span class="o">{</span>
    <span class="nd">@After</span><span class="o">(</span><span class="s">&#34;execution(public void demo.service.UserService.addUser(demo.model.User))&#34;</span><span class="o">)</span>
    <span class="kt">void</span> <span class="nf">after</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;after user add&#34;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nd">@Before</span><span class="o">(</span><span class="s">&#34;execution(public * demo..addUser(*))&#34;</span><span class="o">)</span>
    <span class="kt">void</span> <span class="nf">before</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;before user add&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这样就完成了日志的织入，<code>@After</code> 和 <code>@Before</code> 里面的参数成为切入点语法。</p>

<h3 id="切入点语法">切入点语法</h3>

<p>executoin 表示是在执行方法时候切入，成为切入点指示符。用来指示切入点表达式目的，在 Spring AOP 中目前只有执行方法这一个连接点，Spring AOP 支持的 AspectJ 切入点指示符如下：</p>

<ul>
<li><code>execution</code>：用于匹配方法执行的连接点；</li>
<li><code>within</code>：用于匹配指定类型内的方法执行；</li>
<li><code>this</code>：用于匹配当前 AOP 代理对象类型的执行方法；注意是 AOP 代理对象的类型匹配，这样就可能包括引入接口也类型匹配；</li>
<li><code>target</code>：用于匹配当前目标对象类型的执行方法；注意是目标对象的类型匹配，这样就不包括引入接口也类型匹配；</li>
<li><code>args</code>：用于匹配当前执行的方法传入的参数为指定类型的执行方法；</li>
<li><code>@within</code>：用于匹配所以持有指定注解类型内的方法；</li>
<li><code>@target</code>：用于匹配当前目标对象类型的执行方法，其中目标对象持有指定的注解；</li>
<li><code>@args</code>：用于匹配当前执行的方法传入的参数持有指定注解的执行；</li>
<li><code>@annotation</code>：用于匹配当前执行方法持有指定注解的方法；</li>
<li><code>bean</code>：Spring AOP 扩展的，AspectJ 没有对于指示符，用于匹配特定名称的 Bean 对象的执行方法；</li>
<li><code>reference pointcut</code>：表示引用其他命名切入点，只有 @ApectJ 风格支持，Schema 风格不支持。</li>
</ul>

<p>匹配模式和组合表达式</p>

<ul>
<li><code>..</code> 类型模式中匹配任何数量子包；而在方法参数模式中匹配任何数量参数。</li>
<li><code>*</code> 匹配任何数量字符</li>
<li>可以使用与（&amp;&amp;）、或（||）、非（！）来衔接表达式</li>
</ul>

<h3 id="pointcut">pointcut</h3>

<p>在编写切入点语法点语法时候，发现这个大部分时候都是通用的，这时候就可以使用 <code>@Pointcut</code> 创建一个切入点（匹配模式），该注解利用被修饰的方法名作为标识符，这样就可以简化为下面的代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Pointcut</span><span class="o">(</span><span class="s">&#34;execution(public * demo..addUser(*))&#34;</span><span class="o">)</span>
<span class="kt">void</span> <span class="nf">logMethod</span><span class="o">(){};</span>

<span class="nd">@After</span><span class="o">(</span><span class="s">&#34;logMethod()&#34;</span><span class="o">)</span>
<span class="kt">void</span> <span class="nf">after</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;after user add&#34;</span><span class="o">);</span>
<span class="o">}</span>
<span class="nd">@Before</span><span class="o">(</span><span class="s">&#34;logMethod()&#34;</span><span class="o">)</span>
<span class="kt">void</span> <span class="nf">before</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;before user add&#34;</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="advice">advice</h3>

<p>除了 <code>@Before</code> 和 <code>@After</code> 还可以有 <code>@AfterReturning</code> <code>@AfterThrowing</code> <code>@Around</code> ，其意义和名字一样，只不过需要注意的是 <code>@Around</code> 的用法，需要在切入点方法里调用责任链，这一点和拦截器的 dofilter 很相似。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Around</span><span class="o">(</span><span class="s">&#34;myMethod()&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">aroundMethod</span><span class="o">(</span><span class="n">ProceedingJoinPoint</span> <span class="n">pjp</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;method around start&#34;</span><span class="o">);</span>
    <span class="n">pjp</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;method around end&#34;</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="advice-参数">advice 参数</h3>

<p>上面的 pjp 属于是自动代理的参数，在编写切面逻辑时候，时常会需要将被代理的方法的参数传递给切面，这时候可以这样实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@After</span><span class="o">(</span><span class="s">&#34;execution(public * demo..addUser(*)) &amp;&amp; args(user))&#34;</span><span class="o">)</span>
<span class="kt">void</span> <span class="nf">after</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;after user add &#34;</span> <span class="o">+</span> <span class="n">user</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>看似 <code>&amp;&amp; args(user)</code> 是筛选条件的限定符，其实是将被代理的该名称的参数传递给切面逻辑，切面逻辑需要以同名的参数承接。args 里面可以挑选多个参数，以逗号分隔，如果全部传递的话可以使用 <code>args(user, ..)</code> 的语法简化。</p>

<h3 id="declareparents">DeclareParents</h3>

<p>我们知道切面接口是由动态代理实现，即动态扫描被代理类的接口，然后动态构建一段代码，该段代码具有其所有的接口，在接口实现上添加上自己的业务逻辑，并使用反射包裹调用了原有的接口，然后动态编译，装载编译后 class 到内存中。既然动态包裹修改实现了一个类的接口，那么也是可以直接在该动态生成的代理类上直接 <strong>添加</strong> 接口的。</p>

<p>如想对一不可更改的类上面，添加一个自己的接口，就可以在这个代理类上实现。利用 AspectJ 的 <code>@DeclareParents</code> 就可以轻松实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SayHi</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">SayHai</span><span class="o">();</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">SayHiImpl</span> <span class="kd">implements</span> <span class="n">SayHi</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">SayHai</span><span class="o">()</span> <span class="o">{</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Hi&#34;</span><span class="o">);</span> <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Component</span>
<span class="nd">@Aspect</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogIntercepter</span>  <span class="o">{</span>
    <span class="c1">// value 表明需要被加上的类，defaultImpl 指明了添加的接口的实现类
</span><span class="c1"></span>    <span class="nd">@DeclareParents</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;demo.service.UserService+&#34;</span><span class="o">,</span> <span class="n">defaultImpl</span> <span class="o">=</span> <span class="n">SayHiImpl</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="n">SayHi</span> <span class="n">sayHi</span><span class="o">;</span>
    <span class="c1">// ...
</span><span class="c1"></span><span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>之后在上下文中获取的代理类就多了该接口，测试类中可以强制转化获取该接口</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">ApplicationContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnotationConfigApplicationContext</span><span class="o">(</span><span class="n">UserDaoConfig</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">UserService</span> <span class="n">userService</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">UserService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
<span class="n">user</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">&#34;Scott&#34;</span><span class="o">);</span>
<span class="o">((</span><span class="n">SayHi</span><span class="o">)</span> <span class="n">userService</span><span class="o">).</span><span class="na">SayHai</span><span class="o">();</span>
<span class="n">userService</span><span class="o">.</span><span class="na">addUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="配置式">配置式</h2>

<p>除了注解式的切面还可以使用 xml 配置的切面，首先修改 beans.xml 文件，添加 xsd 和 namespace ，然后添加上 <code>&lt;aop:aspectj-autoproxy/&gt;</code>，最后配置文件的样子可能是这样的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&#34;http://www.springframework.org/schema/beans&#34;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
       <span class="na">xmlns:context=</span><span class="s">&#34;http://www.springframework.org/schema/context&#34;</span>
       <span class="na">xmlns:aop=</span><span class="s">&#34;http://www.springframework.org/schema/aop&#34;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&#34;
</span><span class="s">        http://www.springframework.org/schema/beans
</span><span class="s">        http://www.springframework.org/schema/beans/spring-beans.xsd
</span><span class="s">        http://www.springframework.org/schema/context
</span><span class="s">        http://www.springframework.org/schema/context/spring-context.xsd
</span><span class="s">        http://www.springframework.org/schema/aop
</span><span class="s">        http://www.springframework.org/schema/aop/srping-aop.xsd&#34;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;context:annotation-config/&gt;</span>
    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">&#34;demo&#34;</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!-- 加上 autoproxy --&gt;</span>
    <span class="nt">&lt;aop:aspectj-autoproxy/&gt;</span>

    <span class="c">&lt;!--service 的组件已经使用注解装配完成--&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;userService&#34;</span> <span class="na">class=</span><span class="s">&#34;demo.service.UserService&#34;</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!-- 切面类需要交由 spring 来管理 --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;logInterceptor&#34;</span> <span class="na">class=</span><span class="s">&#34;demo.aop.LogIntercepter&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;aop:config&gt;</span>
        <span class="c">&lt;!-- ref 定义了切面类 --&gt;</span>
        <span class="nt">&lt;aop:aspect</span> <span class="na">id=</span><span class="s">&#34;logAspect&#34;</span> <span class="na">ref=</span><span class="s">&#34;logInterceptor&#34;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">&#34;logMethod&#34;</span> <span class="na">expression=</span><span class="s">&#34;execution(public * demo..addUser(*))&#34;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;aop:before</span> <span class="na">method=</span><span class="s">&#34;before&#34;</span> <span class="na">pointcut=</span><span class="s">&#34;execution(public * demo..addUser(*))&#34;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;aop:after</span> <span class="na">method=</span><span class="s">&#34;after&#34;</span> <span class="na">pointcut-ref=</span><span class="s">&#34;logMethod&#34;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/aop:aspect&gt;</span>
    <span class="nt">&lt;/aop:config&gt;</span>
<span class="nt">&lt;/beans&gt;</span></code></pre></td></tr></table>
</div>
</div>
<p>结合之前的注解式很容易理解上面的一些点：</p>

<ul>
<li><code>&lt;aop:aspect&gt;</code> 对标 <code>@Aspect</code>，ref 指定了其切面类 bean</li>
<li><code>&lt;aop:before&gt;</code> 对标 <code>@Before</code>，aop 后面的 before 指定了 advice 类型，method 指定了切面类对应的方法，pointcut 切入点语法</li>
<li><code>&lt;aop:pointcut&gt;</code> 对标 <code>@Pointcut</code>，使用 pointcut-ref 来指定</li>
</ul>

<p>pointcut 切入点语法里如果需要使用 <code>&amp;</code> 符号需要进行转义，如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;aop:after</span> <span class="na">method=</span><span class="s">&#34;after&#34;</span> <span class="na">pointcut=</span><span class="s">&#34;execution(public * demo..addUser(*)) &amp;amp;&amp;amp; args(user,..)&#34;</span><span class="nt">/&gt;</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="参考">参考</h2>

<ul>
<li><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop" target="_blank">Aspect Oriented Programming with Spring</a></li>
<li>《Spring 实战》</li>
<li>马士兵 动态代理模拟实现 Spring AOP</li>
</ul>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content"><a href="https://creaink.github.com" class="theme-link">Creaink</a></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">2019-01-23</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div><footer class="post-footer">
      <div class="post-tags">
        <div style="margin-bottom:5px">
          <i class="iconfont icon-folder-open"></i>
            <a href="/categories/Spring/">Spring</a>
            </div>
        <div>
          <i class="iconfont icon-label"></i>
            <a href="/tags/Spring/">Spring</a>
            <a href="/tags/JavaWeb/">JavaWeb</a>
            </div>
      </div>

      
      <nav class="post-nav">
        <a class="prev" href="/post/Backend/SpringBoot/Spring-boot-intro.html">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Spring Boot：（一）工程搭建</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/Backend/JavaWeb/Spring/Spring-framework-di.html">
            <span class="next-text nav-default">Spring framework 之依赖注入</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="lv-container" data-id="city" data-uid="MTAyMC80MjAzOS8xODU4Ng">
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];

        if (typeof LivereTower === 'function') { return; }

        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;

        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
    <noscript>Please enable JavaScript to view the comments powered by <a href="https://livere.com/">LiveRe.</a></noscript>
    </div>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:gcreaink@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/creaink" class="iconfont icon-github" title="github"></a>
  <a href="https://creaink.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2019 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author"><a href="https://creaink.github.com" class="theme-link">Creaink</a></span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-131846852-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
